<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.10-dev">
<meta name="Forrest-skin-name" content="pelt">
<title>Apache&trade; FOP Design: Images</title>
<link type="text/css" href="../../skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="../../skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="../../skin/print.css" rel="stylesheet">
<link type="text/css" href="../../skin/profile.css" rel="stylesheet">
<script src="../../skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="../../skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="../../skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="../../favicon.ico">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<!--+
    |header
    +-->
<div class="header">
<!--+
    |start group logo
    +-->
<div class="grouplogo">
<a href="http://xmlgraphics.apache.org/"><img class="logoImage" alt="Apache XML Graphics" src="../../images/group-logo.gif" title="Apache XML Graphics is responsible for the creation and maintenance of software for managing the conversion of XML formats to graphical output, and the creation and maintenance of related software components, based on software licensed to the Foundation"></a>
</div>
<!--+
    |end group logo
    +-->
<!--+
    |start Project Logo
    +-->
<div class="projectlogo">
<a href="http://xmlgraphics.apache.org/fop/"><img class="logoImage" alt="Apache FOP" src="../../images/logo.jpg" title="Apache FOP (Formatting Objects Processor) is the world's first output independent formatter. Output formats currently supported include PDF, PCL, PS, SVG, XML (area tree representation), Print, AWT, MIF and TXT. The primary output target is PDF."></a>
</div>
<!--+
    |end Project Logo
    +-->
<!--+
    |start Search
    +-->
<div class="searchbox">
<form action="http://www.google.com/search" method="get" class="roundtopsmall">
<input value="xmlgraphics.apache.org" name="sitesearch" type="hidden"><input onFocus="getBlank (this, 'Search the site with google');" size="25" name="q" id="query" type="text" value="Search the site with google">&nbsp; 
                    <input name="Search" value="Search" type="submit">
</form>
</div>
<!--+
    |end search
    +-->
<!--+
    |start Tabs
    +-->
<ul id="tabs">
<li>
<a class="unselected" href="../../index.html">Home</a>
</li>
<li>
<a class="unselected" href="../../1.0/index.html">Version 1.0</a>
</li>
<li>
<a class="unselected" href="../../1.1/index.html">Version 1.1</a>
</li>
<li>
<a class="unselected" href="../../trunk/index.html">FOP Trunk</a>
</li>
<li class="current">
<a class="selected" href="../../dev/index.html">Development</a>
</li>
</ul>
<!--+
    |end Tabs
    +-->
</div>
</div>
<div id="main">
<div id="publishedStrip">
<!--+
    |start Subtabs
    +-->
<div id="level2tabs"></div>
<!--+
    |end Endtabs
    +-->
<script type="text/javascript"><!--
document.write("Last Published: " + document.lastModified);
//  --></script>
</div>
<!--+
    |breadtrail
    +-->
<div class="breadtrail">
<a href="http://www.apache.org/">The Apache Software Foundation</a> &gt; <a href="http://xmlgraphics.apache.org/">Apache XML Graphics Project</a><script src="../../skin/breadcrumbs.js" language="JavaScript" type="text/javascript"></script>
</div>
<!--+
    |start Menu, mainarea
    +-->
<!--+
    |start Menu
    +-->
<div id="menu">
<div onclick="SwitchMenu('menu_1.1', '../../skin/')" id="menu_1.1Title" class="menutitle">About</div>
<div id="menu_1.1" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/index.html">Basics</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.2', '../../skin/')" id="menu_selected_1.2Title" class="menutitle" style="background-image: url('../../skin/images/chapter_open.gif');">Design</div>
<div id="menu_selected_1.2" class="selectedmenuitemgroup" style="display: block;">
<div onclick="SwitchMenu('menu_1.2.1', '../../skin/')" id="menu_1.2.1Title" class="menutitle">About</div>
<div id="menu_1.2.1" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/design/index.html">Introduction</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.2.2', '../../skin/')" id="menu_1.2.2Title" class="menutitle">Core Process</div>
<div id="menu_1.2.2" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/design/startup.html">Startup</a>
</div>
<div class="menuitem">
<a href="../../dev/design/parsing.html">XML Parsing</a>
</div>
<div class="menuitem">
<a href="../../dev/design/fotree.html">FO Tree</a>
</div>
<div class="menuitem">
<a href="../../dev/design/properties.html">Properties</a>
</div>
<div class="menuitem">
<a href="../../dev/design/layout.html">Layout</a>
</div>
<div class="menuitem">
<a href="../../dev/design/breakpos.html">Break Possibility</a>
</div>
<div class="menuitem">
<a href="../../dev/design/areas.html">Area Tree</a>
</div>
<div class="menuitem">
<a href="../../dev/design/renderers.html">Renderers</a>
</div>
</div>
<div onclick="SwitchMenu('menu_selected_1.2.3', '../../skin/')" id="menu_selected_1.2.3Title" class="menutitle" style="background-image: url('../../skin/images/chapter_open.gif');">Miscellaneous</div>
<div id="menu_selected_1.2.3" class="selectedmenuitemgroup" style="display: block;">
<div class="menupage">
<div class="menupagetitle">Images</div>
</div>
<div class="menuitem">
<a href="../../dev/design/pdf-library.html">PDF Library</a>
</div>
<div class="menuitem">
<a href="../../dev/design/svg.html">SVG</a>
</div>
<div class="menuitem">
<a href="../../dev/design/embedding.html">Embedding</a>
</div>
<div class="menuitem">
<a href="../../dev/design/extending.html">Extending</a>
</div>
<div class="menuitem">
<a href="../../dev/design/optimise.html">Optimisations</a>
</div>
<div class="menuitem">
<a href="../../dev/design/useragent.html">User Agent</a>
</div>
</div>
<div class="menuitem">
<a href="http://wiki.apache.org/xmlgraphics-fop/FOPProjectPages">Unresolved (Wiki)</a>
</div>
<div class="menuitem">
<a href="../../dev/svg.html">SVG</a>
</div>
<div class="menuitem">
<a href="../../dev/extensions.html">Extensions</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.3', '../../skin/')" id="menu_1.3Title" class="menutitle">Develop</div>
<div id="menu_1.3" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/implement.html">Walk-Thru</a>
</div>
<div class="menuitem">
<a href="http://issues.apache.org/bugzilla/buglist.cgi?bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;email1=&amp;emailtype1=substring&amp;emailassigned_to1=1&amp;email2=&amp;emailtype2=substring&amp;emailreporter2=1&amp;bugidtype=include&amp;bug_id=&amp;changedin=&amp;votes=&amp;chfieldfrom=&amp;chfieldto=Now&amp;chfieldvalue=&amp;product=Fop&amp;short_desc=%5BPATCH%5D&amp;short_desc_type=allwordssubstr&amp;long_desc=&amp;long_desc_type=allwordssubstr&amp;bug_file_loc=&amp;bug_file_loc_type=allwordssubstr&amp;keywords=&amp;keywords_type=anywords&amp;field0-0-0=noop&amp;type0-0-0=noop&amp;value0-0-0=&amp;namedcmd=Fop+all&amp;newqueryname=fop+patch+queue&amp;tofooter=1&amp;order=Reuse+same+sort+as+last+time">Patch Queue</a>
</div>
<div class="menuitem">
<a href="../../dev/conventions.html">Conventions</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.4', '../../skin/')" id="menu_1.4Title" class="menutitle">Test</div>
<div id="menu_1.4" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/testing.html">Testing</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.5', '../../skin/')" id="menu_1.5Title" class="menutitle">Deploy</div>
<div id="menu_1.5" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/doc.html">Doc Mgmt</a>
</div>
<div class="menuitem">
<a href="../../dev/release.html">Release</a>
</div>
<div class="menuitem">
<a href="http://issues.apache.org/bugzilla/buglist.cgi?bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;email1=&amp;emailtype1=substring&amp;emailassigned_to1=1&amp;email2=&amp;emailtype2=substring&amp;emailreporter2=1&amp;bugidtype=include&amp;bug_id=&amp;changedin=&amp;votes=&amp;chfieldfrom=&amp;chfieldto=Now&amp;chfieldvalue=&amp;product=Fop&amp;short_desc=&amp;short_desc_type=allwordssubstr&amp;long_desc=&amp;long_desc_type=allwordssubstr&amp;bug_file_loc=&amp;bug_file_loc_type=allwordssubstr&amp;keywords=&amp;keywords_type=anywords&amp;field0-0-0=noop&amp;type0-0-0=noop&amp;value0-0-0=&amp;order=bug_severity%2Cpriority%20DESC">Bugs</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.6', '../../skin/')" id="menu_1.6Title" class="menutitle">Resources</div>
<div id="menu_1.6" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/faq.html">FAQs</a>
</div>
<div class="menuitem">
<a href="../../dev/tools.html">Tools</a>
</div>
<div class="menuitem">
<a href="http://svn.apache.org/viewvc/xmlgraphics/fop">ViewVC</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.7', '../../skin/')" id="menu_1.7Title" class="menutitle">SubPackages</div>
<div id="menu_1.7" class="menuitemgroup">
<div class="menuitem">
<a href="../../dev/rtflib.html">RTFlib</a>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="../../skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<!--+
  |alternative credits
  +-->
<div id="credit2"></div>
</div>
<!--+
    |end Menu
    +-->
<!--+
    |start content
    +-->
<div id="content">
<div title="raw XML" class="xmllink">
<a class="dida" href="images.xml"><img alt="XML - icon" src="../../skin/images/xmldoc.gif" class="skin"><br>
        XML</a>
</div>
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="images.pdf"><img alt="PDF -icon" src="../../skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<div class="trail">Font size: 
	          &nbsp;<input value="Reset" class="resetfont" title="Reset text" onclick="ndeSetTextSize('reset'); return false;" type="button">      
	          &nbsp;<input value="-a" class="smallerfont" title="Shrink text" onclick="ndeSetTextSize('decr'); return false;" type="button">
	          &nbsp;<input value="+a" class="biggerfont" title="Enlarge text" onclick="ndeSetTextSize('incr'); return false;" type="button">
</div>
<h1>Apache&trade; FOP Design: Images</h1>
<div id="front-matter">
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#intro">Introduction</a>
</li>
<li>
<a href="#Threading">Threading</a>
</li>
<li>
<a href="#Caches">Caches</a>
<ul class="minitoc">
<li>
<a href="#LRU">LRU</a>
</li>
<li>
<a href="#Context">Context</a>
</li>
</ul>
</li>
<li>
<a href="#Invalid+Images">Invalid Images</a>
</li>
<li>
<a href="#Reading">Reading</a>
</li>
<li>
<a href="#Data">Data</a>
</li>
<li>
<a href="#Rendering">Rendering</a>
<ul class="minitoc">
<li>
<a href="#PDF">PDF</a>
</li>
<li>
<a href="#PS">PS</a>
</li>
<li>
<a href="#awt">awt</a>
</li>
</ul>
</li>
</ul>
</div>
</div>

  
<a name="intro"></a>
<h2 class="underlined_10">Introduction</h2>
<div class="section">
<p>Images may only be needed to be loaded when the image is rendered to the
output or to find the dimensions.<br>
An image url may be invalid, this can be costly to find out so we need to
keep a list of invalid image urls.</p>
<p>We have a number of different caching schemes that are possible.</p>
<p>All images are referred to using the url given in the XSL:FO after
removing "url('')" wrapping. This does
not include any sort of resolving such as relative -&gt; absolute. The
external graphic in the FO Tree and the image area in the Area Tree only
have the url as a reference.
The images are handled through a static interface in ImageFactory.</p>
</div>


<a name="Threading"></a>
<h2 class="underlined_10">Threading</h2>
<div class="section">
<p>In a single threaded case with one document the image should be released
as soon as the renderer caches it. If there are multiple documents then
the images could be held in a weak cache in case another document needs to
load the same image.</p>
<p>In a multi threaded case many threads could be attempting to get the same
image. We need to make sure an image will only be loaded once at a
particular time. Once a particular document is finished then we can move
all the images to a common weak cache.</p>
</div>


<a name="Caches"></a>
<h2 class="underlined_10">Caches</h2>
<div class="section">
<a name="LRU"></a>
<h3 class="underlined_5">LRU</h3>
<p>All images are in a common cache regardless of context. To limit the size
of the cache the LRU image is removed to keep the amount of memory used
low. Each image can supply the amount of data held in memory.</p>
<a name="Context"></a>
<h3 class="underlined_5">Context</h3>
<p>Images are cached according to the context, using the FOUserAgent as a key.
Once the context is finished the images are added to a common weak hashmap
so that other contexts can load these images or the data will be garbage
collected if required.</p>
<p>If images are to be used commonly then we cannot dispose of data in the
FopImage when cached by the renderer. Also if different contexts have
different base directories for resolving relative url's then the loading
and caching must be separate. We can have a cache that shares images among
all contexts or only loads an image for a context.</p>
<p>The cache uses an image loader so that it can synchronize the image
loading on an image by image basis. Finding and adding an image loader to
the cache is also synchronized to prevent thread problems.</p>
</div>


<a name="Invalid+Images"></a>
<h2 class="underlined_10">Invalid Images</h2>
<div class="section">
<p>
If an image cannot be loaded for some reason, for example the url is
invalid or the image data is corrupt or an unknown type. Then it should
only attempt to load the image once. All other attempts to get the image
should return null so that it can be easily handled.<br>
This will prevent any extra processing or waiting.</p>
</div>


<a name="Reading"></a>
<h2 class="underlined_10">Reading</h2>
<div class="section">
<p>Once a stream is opened for the image url then a set of image readers is
used to determine what type of image it is. The reader can peek at the
image header or if necessary load the image. The reader can also get the
image size at this stage.
The reader then can provide the mime type to create the image object to
load the rest of the information.</p>
</div>


<a name="Data"></a>
<h2 class="underlined_10">Data</h2>
<div class="section">
<p>The data usually need for an image is the size and either a bitmap or the
original data. Images such as jpeg and eps can be embedded into the
document with the original data. SVG images are converted into a DOM which
needs to be rendered to the PDF. Other images such as gif, tiff etc. are
converted into a bitmap.
Data is loaded by the FopImage by calling load(type) where type is the type of data to load.</p>
</div>



<a name="Rendering"></a>
<h2 class="underlined_10">Rendering</h2>
<div class="section">
<p>Different renderers need to have the information in different forms.</p>
<a name="PDF"></a>
<h3 class="underlined_5">PDF</h3>
<dl>
<dt>original data</dt>  
<dd>JPG, EPS</dd>

<dt>bitmap</dt>  
<dd>gif, tiff, bmp, png</dd>

<dt>other</dt>  
<dd>SVG</dd>
</dl>
<a name="PS"></a>
<h3 class="underlined_5">PS</h3>
<dl>
<dt>bitmap</dt>  
<dd>JPG, gif, tiff, bmp, png</dd>

<dt>other</dt> 
<dd>SVG</dd>
</dl>
<a name="awt"></a>
<h3 class="underlined_5">awt</h3>
<dl>
<dt>bitmap</dt> 
<dd>JPG, gif, tiff, bmp, png</dd>

<dt>other</dt>  
<dd>SVG</dd>
</dl>
<p>The renderer uses the url to retrieve the image from the ImageFactory and
then load the required data depending on the image mime type. If the
renderer can insert the image into the document and use that data for all
future references of the same image then it can cache the reference in the
renderer and the image can be released from the image cache.</p>
</div>

    
<span class="version">
          version 1298724</span>
</div>
<!--+
    |end content
    +-->
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<!--+
    |start bottomstrip
    +-->
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("Last Published: " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         1999-2012 <a href="http://www.apache.org/licenses/">The Apache Software Foundation. Licensed under Apache License 2.0</a>
<br>
    Apache, Apache FOP, the Apache feather logo, and the Apache FOP
    logos are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
  </div>
<!--+
    |end bottomstrip
    +-->
</div>
</body>
</html>
